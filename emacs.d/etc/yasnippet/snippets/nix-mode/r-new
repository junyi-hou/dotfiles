# -*- mode: snippet -*-
# key: r
# name: r-new
# expand-env: ((yas-indent-line 'fixed))
# condition: (string= (buffer-string) "r")
# --
{ pkgs ? import <nixpkgs> { } }:

let
  pythonEnv = pkgs.python39;
  pythonEnvPackages = pkgs.python39Packages;

  rEnv = with pkgs; rWrapper.override {
    packages = with rPackages; [
      IRkernel
      languageserver
      tidyverse
      $1
    ];
  };
  rKernelFile = rPackage: {
    display_name = "R";
    language = "R";
    argv = [ "${rPackage}/bin/R" "--slave" "-e" "IRkernel::main()" "--args" "{connection_file}" ];
  };
  rKernel = pkgs.stdenv.mkDerivation {
    name = "rKernel";
    version = "0.01";
    src = builtins.fetchurl {
      url = https://www.r-project.org/Rlogo.png;
    };
    nativeBuildInput = [ rEnv ];
    unpackPhase = "true";
    installPhase = ''
      mkdir -p $out/kernels/irkernel
      echo '${builtins.toJSON (rKernelFile rEnv)}' > $out/kernels/irkernel/kernel.json
    '';
  };
in

pkgs.mkShell {
  buildInputs = [
    (pythonEnv.withPackages (p: with p; [ jupyter $2 ]))
    rEnv
    rKernel
    ${3:pkgs.nodePackages.pyright}
  ];
  shellHook = ''
    export JUPYTER_PATH=$JUPYTER_PATH''${JUPYTER_PATH:+:}${rKernel}
    $0
  '';
}
