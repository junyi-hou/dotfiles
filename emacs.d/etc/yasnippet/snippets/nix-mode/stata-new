# -*- mode: snippet -*-
# key: stata
# name: stata-new
# expand-env: ((yas-indent-line 'fixed))
# --
{ pkgs ? import <nixpkgs> { } }:

let
  pythonEnv = pkgs.python39;
  pythonEnvPackages = pkgs.python39Packages;
  kernelFile = {
    display_name = "Stata";
    language = "stata";
    argv = [ "python" "-m" "stata_kernel" "-f" "{connection_file}" ];
  };
  stataKernel = pythonEnv.pkgs.buildPythonPackage rec {
    pname = "stata_kernel";
    version = "1.12.2";
    src = pythonEnv.pkgs.fetchPypi {
      inherit pname version;
      sha256 = "23cd0d89e691a138906ea68a12663cb1301b82d1af8db6883c5495708d2e58fa";
    };
    propagatedBuildInputs = with pythonEnvPackages; [
      beautifulsoup4
      jupyter
      pandas
      packaging
      pillow
      pexpect
      pygments
      requests
    ];
    doCheck = false;
    postInstall = ''
      mkdir -p $out/kernels/stata_kernel
      echo '${builtins.toJSON kernelFile}' > $out/kernels/stata_kernel/kernel.json
    '';
  };
  projectRoot = builtins.toString ./.;
in

pkgs.mkShell {
  buildInputs = [
    (pythonEnv.withPackages (p: with p; [ jupyter pandas stataKernel $1 ]))
    ${2:pkgs.nodePackages.pyright}
  ];

  shellHook = ''
    cat > ${projectRoot}/.stata_kernel.conf <<EOF
    [stata_kernel]
    stata_path = stata-bin
    execution_mode = console
    cache_directory = ~/.cache/stata_kernel_cache
    graph_format = svg
    graph_scale = 1
    user_graph_keywords = coefplot,vioplot
    EOF

    export STATA_KERNEL_USER_CONFIG_PATH=${projectRoot}/.stata_kernel.conf
    $0
  '';
}
