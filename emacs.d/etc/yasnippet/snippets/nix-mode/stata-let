# -*- mode: snippet -*-
# name: stata-let
# key: stata
# expand-env: ((yas-indent-line 'fixed))
# condition: (and (save-excursion (re-search-backward "^[[:space:]]*?let[[:space:]\n]+" nil 'no-error)) (save-excursion (re-search-forward "^[[:space:]]*?in[[:space:]\n]+" nil 'no-error)))
# --
stata = stdenv.mkDerivation {
  name = "stata-14";
  src = /home/lactaid/Downloads/stata;
  # FIXME: still complaining not finding the following libraries
  # installing from arch for now
  # (libpng12; ncurses5-compat-libs)
  propagatedBuildInputs = [ ncurses5 libpng12 ];
  installPhase = ''
    export plat=linux.64

    buildDir=$(pwd)
    mkdir -p $out
    cp unix/linux.64/ado.taz $out/ado.tar.Z
    cp unix/linux.64/base.taz $out/base.tar.Z
    cp unix/linux.64/bins.taz $out/bins.tar.Z
    cp unix/linux.64/docs.taz $out/docs.tar.Z
    cp unix/linux.64/setrwxp $out/setrwxp
    cp unix/linux.64/inst2 $out/inst2

    cd $out
    ./inst2 now

    # install license file
    cp $buildDir/stata.lic ./
  '';
};

projectRoot = builtins.toString ./.;

kernelFile = {
  display_name = "Stata";
  language = "stata";
  argv = ["python" "-m" "stata_kernel" "-f" "{connection_file}"];
};

stataKernel = python38.pkgs.buildPythonPackage rec {
  pname = "stata_kernel";
  version = "1.12.2";
  src = builtins.fetchTarball {
    url = https://github.com/kylebarron/stata_kernel/archive/v1.12.2.tar.gz;
  };
  propagatedBuildInputs = with python38Packages; [
    beautifulsoup4
    jupyter
    pandas
    packaging
    pillow
    pexpect
    pygments
    requests
    stata
  ];
  doCheck = false;
  postInstall = ''
  # install kernel files
  mkdir -p $out/kernels/stata_kernel
  echo '\${builtins.toJSON kernelFile}' > $out/kernels/stata_kernel/kernel.json
  '';
};
$0
