#!/usr/bin/env nix-shell
#! nix-shell -i bash -p bash emacs

set -e

if [ "$1" == "--no-tangle" ]; then
    echo "--no-tangle flag is on, skip tangling..."
elif [ "$1" != "" ]; then
    echo "unsupported flag $1"
else
    echo "start tangling modules..."
    project_root=$(git rev-parse --show-toplevel)
    emacs -Q --batch $project_root/main.org -f org-babel-tangle
    echo "done"
fi

project_root=$(git rev-parse --show-toplevel)
$project_root/update-readme $project_root/main.org $project_root/README.org

project_root=$(git rev-parse --show-toplevel)

nix build $project_root --experimental-features "nix-command flakes"

$project_root/result/activate
