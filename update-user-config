#!/usr/bin/env nix-shell
#! nix-shell -i bash -p bash emacs

# this file is auto-generated by main.org, do not modify!

set -e
project_root=$(git rev-parse --show-toplevel)
cd $project_root

if [ "$1" == "--no-tangle" ]; then
    echo "--no-tangle flag is on, skip tangling..."
elif [ "$1" != "" ]; then
    echo "unsupported flag $1"
else
    echo "start tangling modules..."
    emacs -Q --batch ./main.org -f org-babel-tangle
    echo "done"
fi

nix flake lock --update-input emacs-module
./update-readme ./main.org ./README.org

nix build .

if [ -f "result/sw/bin/darwin-rebuild" ]; then
    echo "found nix-darwin activation script, activating..."
    export HOSTNAME=$(uname -n)  # nix-darwin requires a hostname, so, meh
    ./result/sw/bin/darwin-rebuild switch --flake .
elif [ -f "result/activate" ]; then
    echo "found home-manager activation script, activating..."
    ./result/activate
fi
